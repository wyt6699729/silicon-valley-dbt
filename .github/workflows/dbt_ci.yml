name: dbt CI/CD Pipeline

# 触发条件：当你 push 到 main 分支，或者提 Pull Request 时触发
on:
  push:
    branches:
      - main
  pull_request:

env:
  # 将 GitHub Secrets 注入到运行时的环境变量中
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
  SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}

jobs:
  test_connection:
    name: Verify dbt Connection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dbt-snowflake
        run: pip install dbt-snowflake==1.7.0

      - name: Run dbt debug
        # --project-dir: 指向你的 analytics 文件夹
        # --profiles-dir: 指向根目录 (因为 profiles.yml 在这里)
        run: |
          dbt debug --project-dir ./analytics --profiles-dir .